name: Continuous integration
on: [push,pull_request]
  # push:
  #   branches:
  #     - develop
jobs:
  test:
    runs-on: ubuntu-18.04
    services:
      arangodb:
        image: arangodb:3.3.23
        env:
          ARANGO_ROOT_PASSWORD: rootpass
        ports:
          - 8529/tcp
    steps:
      - name: set up golang
        uses: actions/setup-go@v1
        with:
            go-version: 1.11.13

      - name: check out code
        uses: actions/checkout@v1

      - name: download test reporter
        run: |
            curl -L -o cc-test-reporter https://codeclimate.com/downloads/test-reporter/test-reporter-0.6.3-linux-amd64
            chmod +x cc-test-reporter

      - name: before test coverage
        run: ./cc-test-reporter before-build
        env:
            CC_TEST_REPORTER_ID: ${{ secrets.CC_TEST_ID }}

      - name: run test coverage
        env:
          ARANGO_USER: root
          ARANGO_PASS: rootpass
          ARANGO_HOST: localhost
          ARANGO_PORT: ${{ job.services.arangodb.ports[8529] }}
        run: go test -coverprofile c.out -v ./...

      - name: after test coverage
        run: |
            export GIT_BRANCH=$(echo ${GITHUB_REF} | sed -E 's/refs\/(heads|tags)\///')
            ./cc-test-reporter after-build
        env:
            CC_TEST_REPORTER_ID: ${{ secrets.CC_TEST_ID }}
            GIT_COMMIT_SHA: ${{ github.sha }}
